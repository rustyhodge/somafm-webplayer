"use strict";function X2JS(config){function initConfigDefaults(){void 0===config.escapeMode&&(config.escapeMode=!0),config.attributePrefix=config.attributePrefix||"_",config.arrayAccessForm=config.arrayAccessForm||"none",config.emptyNodeForm=config.emptyNodeForm||"text",void 0===config.enableToStringFunc&&(config.enableToStringFunc=!0),config.arrayAccessFormPaths=config.arrayAccessFormPaths||[],void 0===config.skipEmptyTextNodesForObj&&(config.skipEmptyTextNodesForObj=!0),void 0===config.stripWhitespaces&&(config.stripWhitespaces=!0),config.datetimeAccessFormPaths=config.datetimeAccessFormPaths||[]}function initRequiredPolyfills(){function pad(number){var r=String(number);return 1===r.length&&(r="0"+r),r}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|^\n+|(\s|\n)+$/g,"")}),"function"!=typeof Date.prototype.toISOString&&(Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"})}function getNodeLocalName(node){var nodeLocalName=node.localName;return null==nodeLocalName&&(nodeLocalName=node.baseName),(null==nodeLocalName||""==nodeLocalName)&&(nodeLocalName=node.nodeName),nodeLocalName}function getNodePrefix(node){return node.prefix}function escapeXmlChars(str){return"string"==typeof str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):str}function unescapeXmlChars(str){return str.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function toArrayAccessForm(obj,childName,path){switch(config.arrayAccessForm){case"property":obj[childName]instanceof Array?obj[childName+"_asArray"]=obj[childName]:obj[childName+"_asArray"]=[obj[childName]]}if(!(obj[childName]instanceof Array)&&config.arrayAccessFormPaths.length>0){for(var idx=0;idx<config.arrayAccessFormPaths.length;idx++){var arrayPath=config.arrayAccessFormPaths[idx];if("string"==typeof arrayPath){if(arrayPath==path)break}else if(arrayPath instanceof RegExp){if(arrayPath.test(path))break}else if("function"==typeof arrayPath&&arrayPath(obj,childName,path))break}idx!=config.arrayAccessFormPaths.length&&(obj[childName]=[obj[childName]])}}function fromXmlDateTime(prop){var bits=prop.split(/[-T:+Z]/g),d=new Date(bits[0],bits[1]-1,bits[2]),secondBits=bits[5].split(".");if(d.setHours(bits[3],bits[4],secondBits[0]),secondBits.length>1&&d.setMilliseconds(secondBits[1]),bits[6]&&bits[7]){var offsetMinutes=60*bits[6]+Number(bits[7]),sign=/\d\d-\d\d:\d\d$/.test(prop)?"-":"+";offsetMinutes=0+("-"==sign?-1*offsetMinutes:offsetMinutes),d.setMinutes(d.getMinutes()-offsetMinutes-d.getTimezoneOffset())}else-1!==prop.indexOf("Z",prop.length-1)&&(d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds())));return d}function checkFromXmlDateTimePaths(value,childName,fullPath){if(config.datetimeAccessFormPaths.length>0){for(var path=fullPath.split(".#")[0],idx=0;idx<config.datetimeAccessFormPaths.length;idx++){var dtPath=config.datetimeAccessFormPaths[idx];if("string"==typeof dtPath){if(dtPath==path)break}else if(dtPath instanceof RegExp){if(dtPath.test(path))break}else if("function"==typeof dtPath&&dtPath(obj,childName,path))break}return idx!=config.datetimeAccessFormPaths.length?fromXmlDateTime(value):value}return value}function parseDOMChildren(node,path){if(node.nodeType==DOMNodeTypes.DOCUMENT_NODE){for(var result=new Object,nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx);if(child.nodeType==DOMNodeTypes.ELEMENT_NODE){var childName=getNodeLocalName(child);result[childName]=parseDOMChildren(child,childName)}}return result}if(node.nodeType==DOMNodeTypes.ELEMENT_NODE){var result=new Object;result.__cnt=0;for(var nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx),childName=getNodeLocalName(child);child.nodeType!=DOMNodeTypes.COMMENT_NODE&&(result.__cnt++,null==result[childName]?(result[childName]=parseDOMChildren(child,path+"."+childName),toArrayAccessForm(result,childName,path+"."+childName)):(null!=result[childName]&&(result[childName]instanceof Array||(result[childName]=[result[childName]],toArrayAccessForm(result,childName,path+"."+childName))),result[childName][result[childName].length]=parseDOMChildren(child,path+"."+childName)))}for(var aidx=0;aidx<node.attributes.length;aidx++){var attr=node.attributes.item(aidx);result.__cnt++,result[config.attributePrefix+attr.name]=attr.value}var nodePrefix=getNodePrefix(node);return null!=nodePrefix&&""!=nodePrefix&&(result.__cnt++,result.__prefix=nodePrefix),null!=result["#text"]&&(result.__text=result["#text"],result.__text instanceof Array&&(result.__text=result.__text.join("\n")),config.escapeMode&&(result.__text=unescapeXmlChars(result.__text)),config.stripWhitespaces&&(result.__text=result.__text.trim()),delete result["#text"],"property"==config.arrayAccessForm&&delete result["#text_asArray"],result.__text=checkFromXmlDateTimePaths(result.__text,childName,path+"."+childName)),null!=result["#cdata-section"]&&(result.__cdata=result["#cdata-section"],delete result["#cdata-section"],"property"==config.arrayAccessForm&&delete result["#cdata-section_asArray"]),1==result.__cnt&&null!=result.__text?result=result.__text:0==result.__cnt&&"text"==config.emptyNodeForm?result="":result.__cnt>1&&null!=result.__text&&config.skipEmptyTextNodesForObj&&(config.stripWhitespaces&&""==result.__text||""==result.__text.trim())&&delete result.__text,delete result.__cnt,!config.enableToStringFunc||null==result.__text&&null==result.__cdata||(result.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),result}return node.nodeType==DOMNodeTypes.TEXT_NODE||node.nodeType==DOMNodeTypes.CDATA_SECTION_NODE?node.nodeValue:void 0}function startTag(jsonObj,element,attrList,closed){var resultStr="<"+(null!=jsonObj&&null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+element;if(null!=attrList)for(var aidx=0;aidx<attrList.length;aidx++){var attrName=attrList[aidx],attrVal=jsonObj[attrName];config.escapeMode&&(attrVal=escapeXmlChars(attrVal)),resultStr+=" "+attrName.substr(config.attributePrefix.length)+"='"+attrVal+"'"}return resultStr+=closed?"/>":">"}function endTag(jsonObj,elementName){return"</"+(null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+elementName+">"}function endsWith(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)}function jsonXmlSpecialElem(jsonObj,jsonObjField){return"property"==config.arrayAccessForm&&endsWith(jsonObjField.toString(),"_asArray")||0==jsonObjField.toString().indexOf(config.attributePrefix)||0==jsonObjField.toString().indexOf("__")||jsonObj[jsonObjField]instanceof Function?!0:!1}function jsonXmlElemCount(jsonObj){var elementsCnt=0;if(jsonObj instanceof Object)for(var it in jsonObj)jsonXmlSpecialElem(jsonObj,it)||elementsCnt++;return elementsCnt}function parseJSONAttributes(jsonObj){var attrList=[];if(jsonObj instanceof Object)for(var ait in jsonObj)-1==ait.toString().indexOf("__")&&0==ait.toString().indexOf(config.attributePrefix)&&attrList.push(ait);return attrList}function parseJSONTextAttrs(jsonTxtObj){var result="";return null!=jsonTxtObj.__cdata&&(result+="<![CDATA["+jsonTxtObj.__cdata+"]]>"),null!=jsonTxtObj.__text&&(result+=config.escapeMode?escapeXmlChars(jsonTxtObj.__text):jsonTxtObj.__text),result}function parseJSONTextObject(jsonTxtObj){var result="";return jsonTxtObj instanceof Object?result+=parseJSONTextAttrs(jsonTxtObj):null!=jsonTxtObj&&(result+=config.escapeMode?escapeXmlChars(jsonTxtObj):jsonTxtObj),result}function parseJSONArray(jsonArrRoot,jsonArrObj,attrList){var result="";if(0==jsonArrRoot.length)result+=startTag(jsonArrRoot,jsonArrObj,attrList,!0);else for(var arIdx=0;arIdx<jsonArrRoot.length;arIdx++)result+=startTag(jsonArrRoot[arIdx],jsonArrObj,parseJSONAttributes(jsonArrRoot[arIdx]),!1),result+=parseJSONObject(jsonArrRoot[arIdx]),result+=endTag(jsonArrRoot[arIdx],jsonArrObj);return result}function parseJSONObject(jsonObj){var result="",elementsCnt=jsonXmlElemCount(jsonObj);if(elementsCnt>0)for(var it in jsonObj)if(!jsonXmlSpecialElem(jsonObj,it)){var subObj=jsonObj[it],attrList=parseJSONAttributes(subObj);if(null==subObj||void 0==subObj)result+=startTag(subObj,it,attrList,!0);else if(subObj instanceof Object)if(subObj instanceof Array)result+=parseJSONArray(subObj,it,attrList);else if(subObj instanceof Date)result+=startTag(subObj,it,attrList,!1),result+=subObj.toISOString(),result+=endTag(subObj,it);else{var subObjElementsCnt=jsonXmlElemCount(subObj);subObjElementsCnt>0||null!=subObj.__text||null!=subObj.__cdata?(result+=startTag(subObj,it,attrList,!1),result+=parseJSONObject(subObj),result+=endTag(subObj,it)):result+=startTag(subObj,it,attrList,!0)}else result+=startTag(subObj,it,attrList,!1),result+=parseJSONTextObject(subObj),result+=endTag(subObj,it)}return result+=parseJSONTextObject(jsonObj)}var VERSION="1.1.5";config=config||{},initConfigDefaults(),initRequiredPolyfills();var DOMNodeTypes={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(xmlDocStr){var isIEParser=window.ActiveXObject||"ActiveXObject"in window;if(void 0===xmlDocStr)return null;var xmlDoc;if(window.DOMParser){var parser=new window.DOMParser,parsererrorNS=null;if(!isIEParser)try{parsererrorNS=parser.parseFromString("INVALID","text/xml").childNodes[0].namespaceURI}catch(err){parsererrorNS=null}try{xmlDoc=parser.parseFromString(xmlDocStr,"text/xml"),null!=parsererrorNS&&xmlDoc.getElementsByTagNameNS(parsererrorNS,"parsererror").length>0&&(xmlDoc=null)}catch(err){xmlDoc=null}}else 0==xmlDocStr.indexOf("<?")&&(xmlDocStr=xmlDocStr.substr(xmlDocStr.indexOf("?>")+2)),xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(xmlDocStr);return xmlDoc},this.asArray=function(prop){return prop instanceof Array?prop:[prop]},this.toXmlDateTime=function(dt){return dt instanceof Date?dt.toISOString():"number"==typeof dt?new Date(dt).toISOString():null},this.asDateTime=function(prop){return"string"==typeof prop?fromXmlDateTime(prop):prop},this.xml2json=function(xmlDoc){return parseDOMChildren(xmlDoc)},this.xml_str2json=function(xmlDocStr){var xmlDoc=this.parseXmlString(xmlDocStr);return null!=xmlDoc?this.xml2json(xmlDoc):null},this.json2xml_str=function(jsonObj){return parseJSONObject(jsonObj)},this.json2xml=function(jsonObj){var xmlDocStr=this.json2xml_str(jsonObj);return this.parseXmlString(xmlDocStr)},this.getVersion=function(){return VERSION}}var angularLocalStorage=angular.module("LocalStorageModule",[]);angularLocalStorage.provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(prefix){this.prefix=prefix},this.setStorageType=function(storageType){this.storageType=storageType},this.setStorageCookie=function(exp,path){this.cookie={expiry:exp,path:path}},this.setStorageCookieDomain=function(domain){this.cookie.domain=domain},this.setNotify=function(itemSet,itemRemove){this.notify={setItem:itemSet,removeItem:itemRemove}},this.$get=["$rootScope","$window","$document",function($rootScope,$window,$document){var webStorage,prefix=this.prefix,cookie=this.cookie,notify=this.notify,storageType=this.storageType;$document||($document=document),"."!==prefix.substr(-1)&&(prefix=prefix?prefix+".":"");var deriveQualifiedKey=function(key){return prefix+key},browserSupportsLocalStorage=function(){try{var supported=storageType in $window&&null!==$window[storageType],key=deriveQualifiedKey("__"+Math.round(1e7*Math.random()));return supported&&(webStorage=$window[storageType],webStorage.setItem(key,""),webStorage.removeItem(key)),supported}catch(e){return storageType="cookie",$rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}}(),addToLocalStorage=function(key,value){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),notify.setItem&&$rootScope.$broadcast("LocalStorageModule.notification.setitem",{key:key,newvalue:value,storageType:"cookie"}),addToCookies(key,value);"undefined"==typeof value&&(value=null);try{(angular.isObject(value)||angular.isArray(value))&&(value=angular.toJson(value)),webStorage&&webStorage.setItem(deriveQualifiedKey(key),value),notify.setItem&&$rootScope.$broadcast("LocalStorageModule.notification.setitem",{key:key,newvalue:value,storageType:this.storageType})}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),addToCookies(key,value)}return!0},getFromLocalStorage=function(key){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),getFromCookies(key);var item=webStorage?webStorage.getItem(deriveQualifiedKey(key)):null;return item&&"null"!==item?"{"===item.charAt(0)||"["===item.charAt(0)?angular.fromJson(item):item:null},removeFromLocalStorage=function(key){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),notify.removeItem&&$rootScope.$broadcast("LocalStorageModule.notification.removeitem",{key:key,storageType:"cookie"}),removeFromCookies(key);try{webStorage.removeItem(deriveQualifiedKey(key)),notify.removeItem&&$rootScope.$broadcast("LocalStorageModule.notification.removeitem",{key:key,storageType:this.storageType})}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),removeFromCookies(key)}return!0},getKeysForLocalStorage=function(){if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),!1;var prefixLength=prefix.length,keys=[];for(var key in webStorage)if(key.substr(0,prefixLength)===prefix)try{keys.push(key.substr(prefixLength))}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.Description),[]}return keys},clearAllFromLocalStorage=function(regularExpression){regularExpression=regularExpression||"";var tempPrefix=prefix.slice(0,-1),testRegex=new RegExp(tempPrefix+"."+regularExpression);if(!browserSupportsLocalStorage)return $rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),clearAllFromCookies();var prefixLength=prefix.length;for(var key in webStorage)if(testRegex.test(key))try{removeFromLocalStorage(key.substr(prefixLength))}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),clearAllFromCookies()}return!0},browserSupportsCookies=function(){try{return navigator.cookieEnabled||"cookie"in $document&&($document.cookie.length>0||($document.cookie="test").indexOf.call($document.cookie,"test")>-1)}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}},addToCookies=function(key,value){if("undefined"==typeof value)return!1;if(!browserSupportsCookies())return $rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var expiry="",expiryDate=new Date,cookieDomain="";if(null===value?(expiryDate.setTime(expiryDate.getTime()+-864e5),expiry="; expires="+expiryDate.toGMTString(),value=""):0!==cookie.expiry&&(expiryDate.setTime(expiryDate.getTime()+24*cookie.expiry*60*60*1e3),expiry="; expires="+expiryDate.toGMTString()),key){var cookiePath="; path="+cookie.path;cookie.domain&&(cookieDomain="; domain="+cookie.domain),$document.cookie=deriveQualifiedKey(key)+"="+encodeURIComponent(value)+expiry+cookiePath+cookieDomain}}catch(e){return $rootScope.$broadcast("LocalStorageModule.notification.error",e.message),!1}return!0},getFromCookies=function(key){if(!browserSupportsCookies())return $rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var cookies=$document.cookie&&$document.cookie.split(";")||[],i=0;i<cookies.length;i++){for(var thisCookie=cookies[i];" "===thisCookie.charAt(0);)thisCookie=thisCookie.substring(1,thisCookie.length);if(0===thisCookie.indexOf(deriveQualifiedKey(key)+"="))return decodeURIComponent(thisCookie.substring(prefix.length+key.length+1,thisCookie.length))}return null},removeFromCookies=function(key){addToCookies(key,null)},clearAllFromCookies=function(){for(var thisCookie=null,prefixLength=prefix.length,cookies=$document.cookie.split(";"),i=0;i<cookies.length;i++){for(thisCookie=cookies[i];" "===thisCookie.charAt(0);)thisCookie=thisCookie.substring(1,thisCookie.length);var key=thisCookie.substring(prefixLength,thisCookie.indexOf("="));removeFromCookies(key)}},getStorageType=function(){return storageType},bindToScope=function(scope,key,def){var value=getFromLocalStorage(key);null===value&&angular.isDefined(def)?value=def:angular.isObject(value)&&angular.isObject(def)&&(value=angular.extend(def,value)),scope[key]=value,scope.$watchCollection(key,function(newVal){addToLocalStorage(key,newVal)})};return{isSupported:browserSupportsLocalStorage,getStorageType:getStorageType,set:addToLocalStorage,add:addToLocalStorage,get:getFromLocalStorage,keys:getKeysForLocalStorage,remove:removeFromLocalStorage,clearAll:clearAllFromLocalStorage,bind:bindToScope,deriveKey:deriveQualifiedKey,cookie:{set:addToCookies,add:addToCookies,get:getFromCookies,remove:removeFromCookies,clearAll:clearAllFromCookies}}}]}),angular.module("config",[]).constant("AppURLs",{allStations:{url:"/data/channels.xml"},pls:{url:"/data/[STATION_ID].pls",key:"[STATION_ID]"},playList:{url:"/data/[STATION_ID].xml",key:"[STATION_ID]"},community:{sections:[{key:"news",active:!0,config:{dataUrl:"/data/news.xml"}},{key:"twitter",active:!1},{key:"flickr",active:!1},{key:"facebook",active:!1}]}}),angular.module("somafm.tpls",["all-stations/body.tpl.html","all-stations/header.tpl.html","common/body.tpl.html","common/footer.tpl.html","common/header.tpl.html","common/player.tpl.html","common/volumebar.tpl.html","community/body.tpl.html","community/header.tpl.html","community/views/facebook.tpl.html","community/views/flickr.tpl.html","community/views/gallery.tpl.html","community/views/news.tpl.html","community/views/twitter.tpl.html","fav-songs/body.tpl.html","fav-songs/header.tpl.html","fav-stations/body.tpl.html","fav-stations/header.tpl.html","now-playing/body.tpl.html","now-playing/header.tpl.html"]),angular.module("all-stations/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("all-stations/body.tpl.html",'<div class="all-stations">\n  <div class="list-header">\n    <div class="row">\n      <div class="col-xs-4">\n        <h3 class="title">All Stations</h3>\n      </div>\n      <div class="col-xs-8">\n        <div class="btn-group btn-group-sm pull-right">\n          <button ng-repeat="sortType in sort.types" class="btn btn-primary" ng-class="{active: sortType === sort.selectedType}" ng-click="setSort(sortType)">\n            {{sortType.label}}\n            <i class="fa" ng-class="{\'fa-caret-down\': sort.asc, \'fa-caret-up\': !sort.asc}" ng-if="sortType === sort.selectedType"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="list-body">\n\n    <div class="row card" ng-repeat="station in sort.stations" ng-if="sort.selectedType.type !== \'genre\'" ng-click="playStation(station)">\n      <div class="col-xs-2 img-col">\n        <img class="img-responsive" ng-src="{{station.image}}" ng-click="playStation(station)" />\n      </div>\n      <div class="col-xs-8 copy-col">\n        <h4>{{station.title}}</h4>\n        <p>{{station.description}}</p>\n        <p class="small">{{station.listeners}} listeners</p>\n      </div>\n\n      <!--Play Button-->\n      <div class="col-xs-2">\n        <!-- <button class="btn btn-link btn-lg pull-right" ng-click="playStation(station)" ng-show="!isStationPlaying(station)">\n          <i class="fa fa-play"></i>\n        </button>-->\n\n        <!--Stop Button-->\n        <!--<button class="btn btn-link btn-lg pull-right" ng-click="stopStation(station)" ng-show="isStationPlaying(station)">\n          <i class="fa fa-stop"></i>\n        </button>-->\n\n        <!-- Fav Button -->\n        <button class="btn btn-link btn-lg pull-right" ng-class="{\'btn-fav\': station.favorite}" ng-click="toggleFavStation(station)">\n          <i class="fa" ng-class="{\'fa-star\': station.favorite, \'fa-star-o\': !station.favorite}"></i>\n        </button>\n\n      </div>\n    </div>\n\n    <div class="row" ng-repeat="genre in sort.stations" ng-if="sort.selectedType.type === \'genre\'">\n      <div class="col-xs-12">\n        <div class="genre">{{genre.label | uppercase}}</div>\n        <div class="row card" ng-repeat="station in genre.stations" ng-click="playStation(station)">\n          <div class="col-xs-2 img-col">\n            <img class="img-responsive" ng-src="{{station.image}}" ng-click="playStation(station)" />\n          </div>\n          <div class="col-xs-8 copy-col">\n            <h4>{{station.title}}</h4>\n            <p>{{station.description}}</p>\n            <p class="small">{{station.listeners}} listeners</p>\n          </div>\n          <div class="col-xs-2">\n\n            <!--Play Button-->\n            <!--<button class="btn btn-link btn-lg pull-right" ng-click="playStation(station)" ng-show="!isStationPlaying(station)">\n              <i class="fa fa-play"></i>\n            </button>-->\n\n            <!--Stop Button-->\n            <!-- <button class="btn btn-link btn-lg pull-right" ng-click="stopStation(station)" ng-show="isStationPlaying(station)">\n              <i class="fa fa-stop"></i>\n            </button>-->\n\n            <!-- Fav Button -->\n            <button class="btn btn-link btn-lg pull-right" ng-class="{\'btn-fav\': station.favorite}" ng-click="toggleFavStation(station)">\n              <i class="fa" ng-class="{\'fa-star\': station.favorite, \'fa-star-o\': !station.favorite}"></i>\n            </button>\n\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>')}]),angular.module("all-stations/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("all-stations/header.tpl.html",'<div class="all-stations">\n  <img class="img-responsive" src="images/header/28cefbda.new_header.jpg">\n</div>')}]),angular.module("common/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("common/body.tpl.html",'<div class="body"\n     ng-class="{\'has-large-header\': config.largeHeader, \'has-player\': config.hasPlayer}"\n     ui-view="body">\n</div>\n')}]),angular.module("common/footer.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("common/footer.tpl.html",'<div class="footer">\n  <sf-player ng-show="config.hasPlayer"></sf-player>\n  <nav>\n    <a ui-sref-active="selected" ui-sref="all-stations">\n      <img ng-if="!isSelected(\'all-stations\')" class="img-responsive" src="images/nav/312096bd.all_stations_btn.png" />\n      <img ng-if="isSelected(\'all-stations\')" class="img-responsive" src="images/nav/48cce479.all_stations_selected_btn.png" />\n    </a>\n    <a ui-sref-active="selected" ui-sref="fav-stations">\n      <img ng-if="!isSelected(\'fav-stations\')" class="img-responsive" src="images/nav/4707f272.fav_stations_btn.png" />\n      <img ng-if="isSelected(\'fav-stations\')" class="img-responsive" src="images/nav/0bf9e046.fav_stations_selected_btn.png" />\n    </a>\n    <a ui-sref-active="selected" ui-sref="fav-songs">\n      <img ng-if="!isSelected(\'fav-songs\')" class="img-responsive" src="images/nav/aa611af5.fav_songs_btn.png" />\n      <img ng-if="isSelected(\'fav-songs\')" class="img-responsive" src="images/nav/4275d5bb.fav_songs_selected_btn.png" />\n    </a>\n    <a ui-sref-active="selected" ui-sref="community">\n      <img ng-if="!isSelected(\'community\')" class="img-responsive" src="images/nav/a5b337ac.community_btn.png" />\n      <img ng-if="isSelected(\'community\')" class="img-responsive" src="images/nav/4c7475d0.community_selected_btn.png" />\n    </a>\n    <!--    <a ui-sref-active="selected" ui-sref="support">\n      <img ng-if="!isSelected(\'support\')" class="img-responsive" src="../../images/nav/7351364d.donate_btn.png" />\n      <img ng-if="isSelected(\'support\')" class="img-responsive" src="../../images/nav/a1fc9f60.donate_selected_btn.png" />\n    </a> -->\n    <a ng-if="!$root.playingStation" class="disabled">\n      <div class="dimmer"></div>\n      <img class="img-responsive" src="images/nav/832cf0ec.now_playing_btn.png" />\n    </a>\n    <a ng-if="$root.playingStation" ui-sref-active="selected" ui-sref="now-playing({stationID: $root.playingStation._id})">\n      <img ng-if="!isSelected(\'now-playing\')" class="img-responsive" src="images/nav/832cf0ec.now_playing_btn.png" />\n      <img ng-if="isSelected(\'now-playing\')" class="img-responsive" src="images/nav/6a97c18a.now_playing_selected_btn.png" />\n    </a>\n  </nav>\n</div>')}]),angular.module("common/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("common/header.tpl.html",'<div class="header" ng-class="{\'has-large-header\': config.largeHeader}">\n  <div ui-view="header"></div>\n  <div class="notification"></div>\n</div>\n')}]),angular.module("common/player.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("common/player.tpl.html",'<div class="player">\n  <div id=\'audioPlayer\'></div>\n\n  <div class="background">\n    <div class="image-container">\n      <img class="station-img" ng-src="{{$root.playingStation.image}}" />\n    </div>\n  </div>\n\n  <div class="controls-container">\n    <div class="controls">\n\n      <!--Play Button-->\n      <button ng-if=\'!$root.playingStation.playing\' class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'play($root.playingStation)\'>\n        <i class="fa fa-fw fa-lg fa-play"></i>\n      </button>\n\n      <!--Stop Button-->\n      <button ng-if=\'$root.playingStation.playing\' class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'stop()\'>\n        <i class="fa fa-fw fa-lg fa-stop"></i>\n      </button>\n\n      <!--Volume Down-->\n      <button ng-if=\'!isMuted()\' class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'toggleMute()\'>\n        <i class="fa fa-fw fa-lg fa-volume-down"></i>\n      </button>\n\n      <!--Volume Off-->\n      <button ng-if=\'isMuted()\' class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'toggleMute()\'>\n        <i class="fa fa-fw fa-lg fa-volume-off"></i>\n      </button>\n\n      <!--Volume Bar-->\n      <sf-volumebar value=\'volume\' min=\'0\' max=\'1\' ng-disabled=\'!$root.playingStation\' value-change=\'updateVolume(val)\'></sf-volumebar>\n\n      <!--Volume Up-->\n      <button class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'maxVolume()\'>\n        <i class="fa fa-fw fa-lg fa-volume-up"></i>\n      </button>\n\n      <!-- Sleep Timer-->\n      <div class="timer-dropdown" id="timer-button-block" width="54px">\n        <button class=\'btn btn-link\' ng-disabled=\'!$root.playingStation\' ng-click=\'popUpTimer()\' data-toggle="dropdown">\n          <i class="fa fa-fw fa-lg far fa-clock-o" id="timer-icon"></i>\n        </button>\n        <div class="timer-dropdown-content" width="54px" id="timer-content-block">\n          <label>Sleep in:</label>\n          <hr/>\n          <a href="#" ng-click="setSleepTimer(10)">10 mins</a>\n          <br/>\n          <a href="#" ng-click="setSleepTimer(20)">20 mins</a>\n          <br/>\n          <a href="#" ng-click="setSleepTimer(30)">30 mins</a>\n          <br/>\n          <a href="#" ng-click="setSleepTimer(60)">60 mins</a>\n          <br/>\n          <a href="#" ng-click="setSleepTimer(90)">90 mins</a>\n          <br/>\n          <a href="#" ng-click="setSleepTimer(120)">120 mins</a>\n          <br/>\n        </div>\n      </div>\n      <div class="timer-running-dropdown" id="timer-status-block" width="54px">\n        <button id="timer_text" class="btn btn-link timer-text-style" ng-click="popUpStopTimer()">\n        </button>\n        <div class="timer-running-content" width="54px" id="timer-running-block">\n          <button class="btn btn-link" ng-click="stopSleepTimer()">Stop</label>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>')}]),angular.module("common/volumebar.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("common/volumebar.tpl.html","<div class='volumebar'>\n  <div class='track'></div>\n  <div class='value'></div>\n</div>\n")}]),angular.module("community/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/body.tpl.html",'<div class="community">\n  <div class="list-header">\n    <div class="row">\n      <div class="col-xs-4">\n        <h3 class="title">Community</h3>\n      </div>\n      <div class="col-xs-8">\n        <div class="btn-group btn-group-sm pull-right">\n          <button ng-repeat="view in views" class="btn btn-primary" ng-class="{\'active\': selectedView === view}" ng-click="show(view)">\n            {{view.key}}\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="list-body" ng-switch="selectedView.key">\n    <sf-community-news-view ng-switch-when="news"></sf-community-news-view>\n    <sf-community-gallery-view ng-switch-when="gallery"></sf-community-gallery-view>\n    <sf-community-twitter-view ng-switch-when="twitter"></sf-community-twitter-view>\n    <sf-community-flickr-view ng-switch-when="flickr"></sf-community-flickr-view>\n    <sf-community-facebook-view ng-switch-when="facebook"></sf-community-facebook-view>\n  </div>\n</div>')}]),angular.module("community/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/header.tpl.html",'<div class="community">\n  <img class="img-responsive" src="images/header/eab74940.community_header.jpg">\n</div>')}]),angular.module("community/views/facebook.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/views/facebook.tpl.html",'<div class="facebook">\n  <div id="fb-root"></div>\n  <div class="fb-page"\n       data-href="https://www.facebook.com/somafm"\n       data-tabs="timeline"\n       data-width="100%"\n       data-height="100%"\n       data-small-header="false"\n       data-adapt-container-width="true"\n       data-hide-cover="false"\n       data-show-facepile="false">\n    <div class="fb-xfbml-parse-ignore">\n      <blockquote cite="https://www.facebook.com/somafm">\n        <a href="https://www.facebook.com/somafm">SomaFM</a>\n      </blockquote>\n    </div>\n  </div>\n</div>\n')}]),angular.module("community/views/flickr.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/views/flickr.tpl.html","<div class=\"flickr\">\n  <h1>Here are SomaFM listeners from around the world. Send us your pictures with your SomaFM gear to <a href='mailto:dj@somafm.com'>dj@somafm.com</a> and we'll post them on Flickr.</h1>\n  <div></div>\n  <h1>More on Flickr at <a href='http://flickr.com/SomaFM' target='_blank'> www.flickr.com/SomaFM </a></h1>\n</div>\n")}]),angular.module("community/views/gallery.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/views/gallery.tpl.html",'<div class="gallery">\n  <table border=0 cellspacing=0 cellpadding=0 name="gallery_holder" width="100%">\n    <iframe src="http://somafm.com/app/gallery.html" name="targetframe" allowTransparency="true" scrolling="yes" marginwidth=0\n      marginheight=0 frameborder=0>\n    </iframe>\n  </table>\n</div>')}]),angular.module("community/views/news.tpl.html",[]).run(["$templateCache",function($templateCache){
$templateCache.put("community/views/news.tpl.html",'<div class="news"></div>\n')}]),angular.module("community/views/twitter.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("community/views/twitter.tpl.html",'<div class="twitter">\n  <a class="twitter-timeline"\n     data-dnt="true"\n     data-height="100%"\n     href="https://twitter.com/somafm"\n     data-widget-id="686436871421837312">\n    <i class="fa fa-circle-o-notch fa-spin"></i>\n    Loading Tweets...\n  </a>\n</div>\n')}]),angular.module("fav-songs/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("fav-songs/body.tpl.html",'<div class="fav-songs">\n  <div class="list-header">\n    <div class="row">\n      <div class="col-xs-4">\n        <h5>Artist</h5>\n      </div>\n      <div class="col-xs-4">\n        <h5>Song</h5>\n      </div>\n    </div>\n  </div>\n  <div class="list-body">\n    <div class="row card" ng-repeat="song in songs">\n      <div class="col-xs-4">\n        <p>{{song.artist}}</p>\n      </div>\n      <div class="col-xs-5">\n        <p>{{song.title}}</p>\n      </div>\n      <div class="col-xs-3">\n        <div class="pull-right">\n          <button class="btn btn-link btn-lg" ng-click="shopSong(song)">\n            <i class="fa fa-fw fa-shopping-cart"></i>\n          </button>\n          <button class="btn btn-link btn-lg btn-fav" ng-click="remove(song)">\n            <i class="fa fa-fw fa-star"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>')}]),angular.module("fav-songs/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("fav-songs/header.tpl.html",'<div class="fav-songs">\n  <img class="img-responsive" src="images/header/03675fbd.fav_song_header.jpg">\n</div>')}]),angular.module("fav-stations/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("fav-stations/body.tpl.html",'<div class="fav-stations">\n  <div class="list-header">\n    <div class="row">\n      <div class="col-xs-6">\n        <h3 class="title">Favorite Stations</h3>\n      </div>\n      <div class="col-xs-6">\n        <div class="btn-group btn-group-sm pull-right">\n          <button ng-repeat="sortType in sort.types" class="btn btn-primary" ng-class="{active: sortType === sort.selectedType}" ng-click="setSort(sortType)">\n            {{sortType.label}}\n            <i class="fa" ng-class="{\'fa-caret-down\': sort.asc, \'fa-caret-up\': !sort.asc}" ng-if="sortType === sort.selectedType"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="list-body">\n    <div class="row card" ng-repeat="station in sort.stations">\n      <div class="col-xs-2 img-col">\n        <img class="img-responsive" ng-src="{{station.image}}" />\n      </div>\n      <div class="col-xs-8 copy-col">\n        <h4>{{station.title}}</h4>\n        <p>{{station.description}}</p>\n        <p class="small">{{station.listeners}} listeners</p>\n      </div>\n      <div class="col-xs-2">\n        <button class="btn btn-link btn-lg pull-right" ng-click="playStation(station)" ng-show="!isStationPlaying(station)">\n          <i class="fa fa-play"></i>\n        </button>\n        <button class="btn btn-link btn-lg pull-right" ng-click="stopStation(station)" ng-show="isStationPlaying(station)">\n          <i class="fa fa-stop"></i>\n        </button>\n        <button class="btn btn-link btn-lg pull-right" ng-class="{\'btn-fav\': station.favorite}" ng-click="toggleFavStation(station)">\n          <i class="fa" ng-class="{\'fa-star\': station.favorite, \'fa-star-o\': !station.favorite}"></i>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>')}]),angular.module("fav-stations/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("fav-stations/header.tpl.html",'<div class="fav-stations">\n  <img class="img-responsive" src="images/header/28cefbda.new_header.jpg">\n</div>')}]),angular.module("now-playing/body.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("now-playing/body.tpl.html",'<div class="now-playing">\n  <div class="list-header">\n    <div class="row">\n      <div class="col-xs-2">\n        <h5>Time</h5>\n      </div>\n      <div class="col-xs-3">\n        <h5>Artist</h5>\n      </div>\n      <div class="col-xs-7">\n        <h5>Song</h5>\n      </div>\n    </div>\n  </div>\n  <div class="list-body">\n    <div class="row card" ng-repeat="song in songs">\n      <div class="col-xs-2">\n        <p ng-if="$index == 0" class="first">{{ song.date | date: "hh:mm" }}</p>\n        <p ng-if="$index > 0">{{ song.date | date: "hh:mm" }}</p>\n      </div>\n      <div class="col-xs-3">\n        <p ng-if="$index == 0" class="first">{{ song.artist }}</p>\n        <p ng-if="$index > 0">{{ song.artist }}</p>\n      </div>\n      <div class="col-xs-4">\n        <p ng-if="$index == 0" class="first">{{ song.title }}</p>\n        <p ng-if="$index > 0">{{ song.title }}</p>\n      </div>\n      <div class="col-xs-3">\n        <div class="pull-right">\n          <!--          <div class="shop-dropdown"> -->\n          <button class="btn btn-link btn-lg" ng-click="shopSong(song)">\n            <!--shopSong(song)-->\n            <i class="fa fa-fw fa-shopping-cart"></i>\n          </button>\n          <!--<div class="shop-dropdown-content" width="54px" id="shop-content-block-{{$index}}">\n              <a href="#" ng-click="shopSong(song)">Shop Amazon</a>\n            </div> \n        </div> -->\n          <button\n            class="btn btn-link btn-lg"\n            ng-class="{\'btn-fav\': song.favorite}"\n            ng-click="toggleFavSong(song)"\n          >\n            <i\n              class="fa fa-fw "\n              ng-class="{\'fa-star\': song.favorite, \'fa-star-o\': !song.favorite}"\n            ></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n')}]),angular.module("now-playing/header.tpl.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("now-playing/header.tpl.html",'<div class="now-playing">\n  <div class="row">\n    <div class="col-xs-2 img_col">\n      <img class="img-responsive" ng-src="{{ station.image }}" />\n    </div>\n    <div class="col-xs-10 content_col">\n      <h4>{{ station.title }}</h4>\n      <p>{{ station.description }}</p>\n      <p>\n        <button\n          class="btn btn-link btn-large btn-fav"\n          ng-click="toggleFavStation(station)"\n        >\n          <i\n            class="fa"\n            ng-class="{\'fa-star\': station.favorite, \'fa-star-o\': !station.favorite}"\n          ></i>\n        </button>\n        Music Director:\n        <a href="mailto:{{ station.djmail }}" target="_blank">{{\n          station.dj\n        }}</a>\n      </p>\n    </div>\n  </div>\n\n  <div class="row">\n    <div class="col-xs-12 content_col amazon">\n      <p>\n        Cart icons search Amazon.com. SomaFM is an Amazon Affiliate and receives\n        a commission on these purchases.\n      </p>\n    </div>\n  </div>\n</div>\n')}]),angular.module("somafmPlayerApp",["ngCookies","ngResource","ngSanitize","config","LocalStorageModule","ui.router","somafm.tpls","jtt_aping"]).constant("USE_HTML_AUDIO",function(){var elem=document.createElement("audio");if("function"==typeof elem.canPlayType){var playable=elem.canPlayType("audio/mpeg");if("maybe"==playable.toLowerCase()||"probably"==playable.toLowerCase())return!0}return!1}()).constant("POLL_INT",3e4).constant("SHOP_URI","http://somafm.com/buy/webplayerbuy.cgi?mode=amazon&title={SONG}&artist={ARTIST}").constant("X2JS",window.X2JS).constant("Audio",window.Audio).constant("AudioContext",window.AudioContext).config(["localStorageServiceProvider",function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("somafm")}]).config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("all-stations",{url:"/all-stations",data:{largeHeader:!1,title:"SomaFM Player: All Stations"},views:{header:{template:"<sf-all-stations-header></sf-all-stations-header>"},body:{template:"<sf-all-stations-body></sf-all-stations-body>"}},title:"All Stations"}).state("fav-stations",{url:"/fav-stations",data:{largeHeader:!1,title:"SomaFM Player: Favorite Stations"},views:{header:{template:"<sf-fav-stations-header></sf-fav-stations-header>"},body:{template:"<sf-fav-stations-body></sf-fav-stations-body>"}}}).state("fav-songs",{url:"/fav-songs",data:{largeHeader:!1,title:"SomaFM Player: Favorite Songs"},views:{header:{template:"<sf-fav-songs-header></sf-fav-songs-header>"},body:{template:"<sf-fav-songs-body></sf-fav-songs-body>"}}}).state("community",{url:"/community",data:{largeHeader:!1,title:"SomaFM Player: Community"},views:{header:{template:"<sf-community-header></sf-community-header>"},body:{template:"<sf-community-body></sf-community-body>"}}}).state("support",{url:"/support",data:{largeHeader:!1},views:{header:{template:"<sf-support-header></sf-support-header>"},body:{template:"<sf-support-body></sf-support-body>"}}}).state("now-playing",{url:"/now-playing/:stationID",data:{largeHeader:!0,title:"SomaFM Player: Groove Salad (or whatever channel is playing)"},views:{header:{template:"<sf-now-playing-header></sf-now-playing-header>"},body:{template:"<sf-now-playing-body></sf-now-playing-body>"}}}),$urlRouterProvider.otherwise("/all-stations")}]).run(function($rootScope){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState){document.title=toState.data.title})}),angular.module("somafmPlayerApp").directive("sfAllStationsBody",["$state","StationService","PlayerService","WebAudioPlayerService","FavStationsService",function($state,StationService,PlayerService,WebAudioPlayerService,FavStationsService){return{restrict:"E",replace:!0,templateUrl:"all-stations/body.tpl.html",link:function(scope,element,attr){scope.sort={types:[{label:"Popularity",type:"popularity",defaultAsc:!1},{label:"Name",type:"name",defaultAsc:!0},{label:"Genre",type:"genre",defaultAsc:!0}],selectedType:null,asc:!0,stations:[]},scope.setSort=function(sortType){scope.sort.selectedType===sortType?scope.sort.asc=!scope.sort.asc:(scope.sort.selectedType=sortType,scope.sort.asc=sortType.defaultAsc),scope.loadStations()},scope.loadStations=function(sortType){StationService.getStations().then(function(stations){var sortedStation=null;switch(scope.sort.selectedType.type){case"name":sortedStation=_.sortBy(stations,"title"),scope.sort.asc||sortedStation.reverse(),scope.sort.stations=sortedStation;break;case"popularity":sortedStation=_.sortBy(stations,function(station){return parseInt(station.listeners)}),scope.sort.asc||sortedStation.reverse(),scope.sort.stations=sortedStation;break;case"genre":stations=_.map(stations,function(station){return station.genres=station.genre.split("|"),station});var genres=_.chain(stations).pluck("genres").flatten().uniq().value().sort();sortedStation=_.map(genres,function(genre){return{label:genre,stations:_.chain(stations).filter(function(station){return _.contains(station.genres,genre)}).sortBy("title").value()}}),scope.sort.asc||sortedStation.reverse(),scope.sort.stations=sortedStation}},function(error){console.error(error)})},scope.playStation=function(station){$state.go("now-playing",{stationID:station._id})},scope.isStationPlaying=function(station){return PlayerService.isPlaying(station)},scope.stopStation=function(){WebAudioPlayerService.stop()},scope.toggleFavStation=function(station){FavStationsService.toggle(station).then(function(){scope.loadStations()},function(error){scope.loadStations()})},scope.setSort(_.findWhere(scope.sort.types))}}}]),angular.module("somafmPlayerApp").directive("sfAllStationsHeader",[function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"all-stations/header.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").factory("StationService",["$http","$log","$q","AppURLs","FavStationsService","StationTransform","PlsTransform","PlaylistTransform",function($http,$log,$q,AppURLs,FavStationsService,StationTransform,PlsTransform,PlaylistTransform){var parseData=!0,stations=[],getStations=function(){return $q(function(resolve,reject){if(stations.length>0)resolve(stations);else{var opts={};parseData&&(opts.transformResponse=StationTransform),$http.get(AppURLs.allStations.url,opts).success(function(response){FavStationsService.getStations().then(function(favs){stations=_.map(response,function(station){return station.favorite=_.contains(favs,station._id),station}),resolve(stations)},reject)}).error(reject)}})},getStationDetails=function(stationId){return $q(function(resolve,reject){getStations().then(function(stations){var match=_.findWhere(stations,{_id:stationId});resolve(null!=match?match:null)},reject)})},getStationPls=function(stationId){return $q(function(resolve,reject){var url=AppURLs.pls.url.replace(AppURLs.pls.key,stationId),opts={};parseData&&(opts.transformResponse=PlsTransform),$http.get(url,opts).success(resolve).error(reject)})},getStationPlayList=function(stationId){return $q(function(resolve,reject){var url=AppURLs.playList.url.replace(AppURLs.playList.key,stationId),opts={};parseData&&(opts.transformResponse=PlaylistTransform),$http.get(url,opts).success(resolve).error(reject)})};return{getStations:getStations,getStationDetails:getStationDetails,getStationPls:getStationPls,getStationPlayList:getStationPlayList,parseXML:function(val){parseData=val}}}]),angular.module("somafmPlayerApp").factory("PlaylistTransform",[function(){return function(data){var x2js=new X2JS,json=x2js.xml_str2json(data),parsedSongs=[],songs=json.songs.song;return angular.forEach(songs,function(song){var parsedSong={};angular.forEach(song,function(prop,key){"date"===key?parsedSong[key]=new Date(1e3*parseInt(prop)):parsedSong[key]=prop.toString()}),parsedSongs.push(parsedSong)}),parsedSongs}}]),angular.module("somafmPlayerApp").factory("PlsTransform",[function(){return function(data){var entries={};angular.forEach(data.split("\n"),function(item){var entry=item.split("=");entry.length>1&&(entries[entry[0].toLowerCase()]=entry[1])});for(var count=entries.numberofentries,urls=[],i=1;count>=i;i++){var url=entries["file"+i];urls.push(url)}return urls}}]),angular.module("somafmPlayerApp").factory("StationTransform",["X2JS",function(X2JS){return function(data){var x2js=new X2JS,xmlDoc=x2js.parseXmlString(data),json=x2js.xml2json(xmlDoc),parsedChannels=[],channels=json.channels.channel;return angular.forEach(channels,function(channel){var parsedChannel={};angular.forEach(channel,function(prop,key){parsedChannel[key]=prop.toString()}),parsedChannels.push(parsedChannel)}),parsedChannels}}]),angular.module("somafmPlayerApp").controller("MainCtrl",["$rootScope","$scope","$state","PlayerService",function($rootScope,$scope,$state,PlayerService){var self=this;self.config={largeHeader:!1,hasPlayer:!1},$scope.$watch(function(){return $state.current},function(state){state.data&&(self.config.largeHeader=state.data.largeHeader)}),$rootScope.$watch("playingStation",function(playingStation){self.config.hasPlayer=null!=playingStation})}]),angular.module("somafmPlayerApp").directive("sfBody",["PlayerService",function(PlayerService){return{restrict:"E",replace:!0,scope:{config:"="},templateUrl:"common/body.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").directive("sfFooter",["$state",function($state){return{restrict:"E",replace:!0,scope:{config:"="},templateUrl:"common/footer.tpl.html",link:function(scope,element,attr){scope.isSelected=function(name){return $state.current.name==name}}}}]),angular.module("somafmPlayerApp").directive("sfHeader",[function(){return{restrict:"E",replace:!0,scope:{config:"="},templateUrl:"common/header.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").directive("sfPlayer",["$rootScope","$timeout","PlayerService","WebAudioPlayerService","SleepTimerService",function($rootScope,$timeout,PlayerService,WebAudioPlayerService,SleepTimerService){return{restrict:"E",replace:!0,scope:{},templateUrl:"common/player.tpl.html",link:function(scope,element,attr){scope.playing=!1,scope.play=function(station){WebAudioPlayerService.play(station)},scope.stop=function(){WebAudioPlayerService.stop()},scope.maxVolume=function(){scope.setVolume(1)},scope.updateVolume=function(value){scope.setVolume(value)},scope.setVolume=function(value){scope.volume=WebAudioPlayerService.setVolume(value)},scope.toggleMute=function(){WebAudioPlayerService.toggleMute()},scope.isMuted=function(){return WebAudioPlayerService.getMuted()},scope.popUpTimer=function(){"none"==document.getElementById("timer-content-block").style.display||""==document.getElementById("timer-content-block").style.display?document.getElementById("timer-content-block").style.display="block":document.getElementById("timer-content-block").style.display="none"},scope.popUpStopTimer=function(){"none"==document.getElementById("timer-running-block").style.display||""==document.getElementById("timer-running-block").style.display?document.getElementById("timer-running-block").style.display="block":document.getElementById("timer-running-block").style.display="none"},scope.setSleepTimer=function(value){document.getElementById("timer-content-block").style.display="none",SleepTimerService.start(value,function(){scope.stop(),document.getElementById("timer-status-block").style.display="none",document.getElementById("timer-button-block").style.display="inline-block"},function(tick){document.getElementById("timer-status-block").style.display="inline-block",document.getElementById("timer_text").innerHTML=tick}),document.getElementById("timer-button-block").style.display="none"},scope.stopSleepTimer=function(){SleepTimerService.stop(),document.getElementById("timer-running-block").style.display="none",document.getElementById("timer-status-block").style.display="none",document.getElementById("timer-button-block").style.display="inline-block"},scope.init=function(){WebAudioPlayerService.init(document.getElementById("audioPlayer")),scope.volume=WebAudioPlayerService.getVolume()},scope.init(),$rootScope.$watch("playingStation",function(station){scope.playing=null!=station?station.playing:!1})}}}]),angular.module("somafmPlayerApp").directive("sfVolumebar",[function(){return{restrict:"E",replace:!0,scope:{value:"=",valueChange:"&"},templateUrl:"common/volumebar.tpl.html",link:function(scope,element,attr){function _calcScrubberWidth(x){var dif=x-offset;if(0>dif)dif=attr.min,scrubber.css("width","0%"),scope.value=attr.min;else if(dif>width)dif=attr.max,scrubber.css("width","100%"),scope.value=attr.max;else{var per=dif/width;scrubber.css("width",100*per+"%"),scope.value=per*attr.max}scope.valueChange({val:scope.value}),scope.$apply()}var width,offset,scrubber=element.children().eq(1),dragging=!1;scope.$watch("value",function(val){scrubber.css("width",val/attr.max*100+"%")}),element.on("mousedown",function(event){dragging=!0,width=element[0].getBoundingClientRect().width,offset=element[0].getBoundingClientRect().left}),element.on("mouseup",function(event){dragging=!1,_calcScrubberWidth(event.pageX)}),element.on("mousemove",function(event){dragging&&_calcScrubberWidth(event.pageX)})}}}]),angular.module("somafmPlayerApp").factory("SleepTimerService",["$q","$rootScope","$interval",function($q,$rootScope,$interval){var interval,states=states={PENDING:0,STARTED:1},intervalTimeout=0,self=this;self.state=states.PENDING,self.timeElapsed=0;var start=function(value,callback,uiUpdate){if(self.state===states.PENDING){self.timeElapsed=0,intervalTimeout=1e3*value*60;var diff=intervalTimeout-self.timeElapsed,hours=Math.floor(diff%864e5/36e5),mins=Math.floor(diff%36e5/6e4),secs=Math.floor(diff%6e4/1e3),hoursString=hours;10>hours&&(hoursString=hoursString);var minString=mins;10>mins&&(minString="0"+minString);var secString=secs;10>secs&&(secString="0"+secString);var data=hoursString+":"+minString+":"+secString;uiUpdate(data),interval=$interval(function(){if(self.timeElapsed>=intervalTimeout)null!=callback&&(stop(),callback());else{self.timeElapsed+=1e3;var diff=intervalTimeout-self.timeElapsed,hours=Math.floor(diff%864e5/36e5),mins=Math.floor(diff%36e5/6e4),secs=Math.floor(diff%6e4/1e3),hoursString=hours;10>hours&&(hoursString=hoursString);var minString=mins;10>mins&&(minString="0"+minString);var secString=secs;10>secs&&(secString="0"+secString);var data=hoursString+":"+minString+":"+secString;uiUpdate(data)}},1e3),self.state=states.STARTED}},stop=function(){self.state===states.STARTED&&($interval.cancel(interval),self.state=states.PENDING)},reset=function(callback){stop(),start(intervalTimeout,callback)};return{start:start,stop:stop,reset:reset}}]),angular.module("somafmPlayerApp").factory("StorageService",["$q","localStorageService",function($q,localStorageService){var rootKey="storage.service.",lsFn=localStorageService.isSupported?localStorageService:localStorageService.cookie,get=function(key,noRoot){return lsFn.get(noRoot?key:rootKey+key)},add=function(key,value,noRoot){lsFn.add(noRoot?key:rootKey+key,value)},remove=function(key,noRoot){return lsFn.remove(noRoot?key:rootKey+key)};return{add:add,get:get,remove:remove}}]),angular.module("somafmPlayerApp").directive("sfCommunityBody",["AppURLs","CommunityService",function(AppURLs,CommunityService){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/body.tpl.html",link:function(scope,element,attr){scope.views=_.filter(AppURLs.community.sections,function(section){return section.active}),scope.selectedView=_.first(scope.views),scope.show=function(view){scope.selectedView=view}}}}]),angular.module("somafmPlayerApp").directive("sfCommunityHeader",[function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/header.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").directive("sfCommunityFacebookView",["$timeout","CommunityService",function($timeout,CommunityService){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/views/facebook.tpl.html",link:function(scope,element,attr){var showWidget=function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5",fjs.parentNode.insertBefore(js,fjs))};showWidget(document,"script","facebook-jssdk")}}}]),angular.module("somafmPlayerApp").directive("sfCommunityFlickrView",["$timeout","CommunityService",function($timeout,CommunityService){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/views/flickr.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").directive("sfCommunityGalleryView",["$timeout","CommunityService",function($timeout,CommunityService){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/views/gallery.tpl.html",link:function(scope,element,attr){var load=function(){};load()}}}]),angular.module("somafmPlayerApp").directive("sfCommunityNewsView",["$timeout","CommunityService",function($timeout,CommunityService){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/views/news.tpl.html",link:function(scope,element,attr){var timer=null,formatDate=function(date){return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()},load=function(){$timeout.cancel(timer),element.html(""),CommunityService.loadNews().then(function(response){if(response.banner&&element.append('<div class="banner">'+response.banner+"</div>"),response.items){element.append("<h1>News Updates</h1>");var itemsHtml="";angular.forEach(response.items,function(item){item.date&&(itemsHtml+="<dt>"+formatDate(item.date)+"</dt>"),itemsHtml+="<dd>"+item.content+"</dd>"}),element.append("<dl>"+itemsHtml+"</dl>"),timer=$timeout(load,1e4)}})};scope.$on("$destroy",function(){timer&&$timeout.cancel(timer)}),load()}}}]),angular.module("somafmPlayerApp").directive("sfCommunityTwitterView",[function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"community/views/twitter.tpl.html",link:function(scope,element,attr){var loadWidget=function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?"http":"https";d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src=p+"://platform.twitter.com/widgets.js",fjs.parentNode.insertBefore(js,fjs))};loadWidget(document,"script","twitter-wjs")}}}]),angular.module("somafmPlayerApp").factory("CommunityService",["$http","$log","$q","AppURLs","NewsTransform",function($http,$log,$q,AppURLs,NewsTransform){var parseData=!0,loadNews=function(){return $q(function(resolve,reject){var opts={};parseData&&(opts.transformResponse=NewsTransform);var url=_.findWhere(AppURLs.community.sections,{key:"news"}).config.dataUrl;$http.get(url,opts).success(function(result){resolve(result)}).error(function(error){$log.error("News couldn't be loaded",error),reject(error)})})},loadTwitter=function(){return $q(function(resolve,reject){$http.get("",{}).success(function(result){resolve(result)}).error(function(error){$log.error("Station list couldn't be loaded",error),reject(error)})})},loadFlickr=function(){return $q(function(resolve,reject){$http.jsonp("http://api.flickr.com/services/feeds/photos_public.gne?id=89961858@N00&lang=en-us&format=json&jsoncallback=?").success(function(result){resolve(result)}).error(function(error){$log.error("Flickr feed couldn't be loaded",error),reject(error)})})},loadGallery=function(){return $q(function(resolve,reject){resolve({})})},loadFacebook=function(){return $q(function(resolve,reject){$http.get("",{}).success(function(result){resolve(result)}).error(function(error){$log.error("Facebook feed couldn't be loaded",error),reject(error)})})};return{loadNews:loadNews,loadTwitter:loadTwitter,loadFlickr:loadFlickr,loadFacebook:loadFacebook,loadGallery:loadGallery}}]),angular.module("somafmPlayerApp").factory("NewsTransform",[function(){return function(data){var x2js=new X2JS,xmlDoc=x2js.parseXmlString(data),json=x2js.xml2json(xmlDoc),news=json.news;news.banner=news.banner.__cdata;var newsItems=[];return angular.forEach(news.items.item,function(item){var date=new Date;date.setTime(1e3*parseInt(item.date)),newsItems.push({content:item.content.__cdata,date:date})}),news.items=newsItems,news}}]),angular.module("somafmPlayerApp").directive("sfFavSongsBody",["$window","SHOP_URI","FavSongsService",function($window,SHOP_URI,FavSongsService){return{restrict:"E",replace:!0,scope:{},templateUrl:"fav-songs/body.tpl.html",link:function(scope,element,attr){scope.songs=[],scope.loadSongs=function(){FavSongsService.get().then(function(songs){scope.songs=songs})},scope.remove=function(song){FavSongsService.remove(song).then(function(){scope.loadSongs()},function(){scope.loadSongs()})},scope.shopSong=function(song){var url=SHOP_URI;url=url.replace("{ARTIST}",song.artist),url=url.replace("{SONG}",song.title),$window.open(url)},scope.loadSongs()}}}]),angular.module("somafmPlayerApp").directive("sfFavSongsHeader",[function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"fav-songs/header.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").factory("FavSongsService",["$log","$q","StorageService",function($log,$q,StorageService){var songs=[],songKey="fav-songs",getSongs=function(refresh){return angular.isUndefined(refresh)&&(refresh=!1),$q(function(resolve,reject){refresh&&null!=songs?resolve(songs):(songs=StorageService.get(songKey)||null,resolve(songs))})},addSong=function(song){return $q(function(resolve,reject){getSongs().then(function(songs){angular.isDefined(song)&&reject(),song.favorite=!0,null==songs&&(songs=[]),songs.push(_.pick(song,"title","artist","album","albumart","date")),StorageService.add(songKey,songs),getSongs(!0).then(resolve,reject)})})},removeSong=function(song){return $q(function(resolve,reject){getSongs().then(function(songs){angular.isDefined(song)||reject();var songMatch=_.findWhere(songs,{artist:song.artist,album:song.album,title:song.title});null!=songMatch&&(song.favorite=!1,songs.splice(_.indexOf(songs,songMatch),1),StorageService.add(songKey,songs)),getSongs(!0).then(resolve,reject)})})},isFav=function(song){return $q(function(resolve,reject){getSongs().then(function(songs){resolve(null!=_.findWhere(songs,{artist:song.artist,title:song.title}))})})},toggleSongs=function(song){return $q(function(resolve,reject){isFav(song).then(function(fav){fav?removeSong(song).then(resolve,reject):addSong(song).then(resolve,reject)},reject)})},clearSongs=function(){return $q(function(resolve){StorageService.add(songKey,""),resolve()})};return{get:getSongs,add:addSong,remove:removeSong,clear:clearSongs,toggle:toggleSongs,isFav:isFav}}]),angular.module("somafmPlayerApp").directive("sfFavStationsBody",["$q","$state","StationService","FavStationsService","PlayerService",function($q,$state,StationService,FavStationsService,PlayerService){return{restrict:"E",replace:!0,scope:{},templateUrl:"fav-stations/body.tpl.html",link:function(scope,element,attr){scope.sort={types:[{label:"Name",type:"name",defaultAsc:!0},{label:"Popularity",type:"popularity",defaultAsc:!1}],selectedType:null,asc:!0,stations:[]},scope.setSort=function(sortType){scope.sort.selectedType===sortType?scope.sort.asc=!scope.sort.asc:(scope.sort.selectedType=sortType,scope.sort.asc=sortType.defaultAsc),scope.loadStations()},scope.loadStations=function(){FavStationsService.getStations().then(function(stations){var calls=[],loadedStations=[];_.each(stations,function(station){calls.push(StationService.getStationDetails(station).then(function(station){null!=station&&loadedStations.push(station)}))}),$q.all(calls).then(function(){var sortedStation=null;switch(scope.sort.selectedType.type){case"name":sortedStation=_.sortBy(loadedStations,"title"),scope.sort.asc||sortedStation.reverse(),scope.sort.stations=sortedStation;break;case"popularity":sortedStation=_.sortBy(loadedStations,function(station){return parseInt(station.listeners)}),scope.sort.asc||sortedStation.reverse(),scope.sort.stations=sortedStation}},function(error){console.error(error)})},function(error){console.error(error)})},scope.playStation=function(station){$state.go("now-playing",{stationID:station._id})},scope.isStationPlaying=function(station){return PlayerService.isPlaying(station)},scope.stopStation=function(){PlayerService.stop()},scope.toggleFavStation=function(station){FavStationsService.toggle(station).then(function(){scope.loadStations()},function(error){scope.loadStations()})},scope.setSort(_.first(scope.sort.types))}}}]),angular.module("somafmPlayerApp").directive("sfFavStationsHeader",[function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"fav-stations/header.tpl.html",link:function(scope,element,attr){}}}]),angular.module("somafmPlayerApp").factory("FavStationsService",["$http","$log","$q","StorageService",function($http,$log,$q,StorageService){var key="fav-stations",getStations=function(){return $q(function(resolve){resolve((StorageService.get(key)||"").split(","))})},add=function(station){return $q(function(resolve,reject){station.favorite=!0,getStations().then(function(stations){-1==stations.indexOf(station._id)&&stations.push(station._id),StorageService.add(key,stations.length>0?stations.join(","):null),resolve()},reject)})},remove=function(station){return $q(function(resolve,reject){station.favorite=!1,getStations().then(function(stations){stations.indexOf(station._id)>-1&&stations.splice(stations.indexOf(station._id),1),StorageService.add(key,stations.length>0?stations.join(","):null),resolve()},reject)})},toggle=function(station){return $q(function(resolve,reject){station.favorite=!station.favorite,station.favorite?add(station).then(resolve,reject):remove(station).then(resolve,reject)})};return{getStations:getStations,toggle:toggle}}]),angular.module("somafmPlayerApp").directive("sfNowPlayingBody",["$q","$timeout","$window","$state","$stateParams","PlayerService","WebAudioPlayerService","StationService","FavStationsService","FavSongsService","POLL_INT","SHOP_URI",function($q,$timeout,$window,$state,$stateParams,PlayerService,WebAudioPlayerService,StationService,FavStationsService,FavSongsService,POLL_INT,SHOP_URI){
return{restrict:"E",replace:!0,scope:{},templateUrl:"now-playing/body.tpl.html",link:function(scope,element,attr){var timer=null;scope.station=null,scope.songs=[],scope.loadSongs=function(){var loadPlaylist=StationService.getStationPlayList($stateParams.stationID),loadFavSongs=FavSongsService.get();$q.all([loadPlaylist,loadFavSongs]).then(function(results){var songs=results[0],favSongs=results[1];scope.songs=_.map(songs,function(song){return song.favorite=angular.isDefined(_.findWhere(favSongs,{artist:song.artist,album:song.album,title:song.title})),song}),$timeout.cancel(timer),timer=$timeout(function(){scope.loadSongs()},POLL_INT)})},scope.toggleFavSong=function(song){FavSongsService.toggle(song)},scope.shopSong=function(song){var url=SHOP_URI;url=url.replace("{ARTIST}",song.artist),url=url.replace("{SONG}",song.title),console.log(url),$window.open(url)},scope.popUpShop=function(song,index){"none"==document.getElementById("shop-content-block-"+index).style.display||""==document.getElementById("shop-content-block-"+index).style.display?document.getElementById("shop-content-block-"+index).style.display="block":document.getElementById("shop-content-block-"+index).style.display="none"},scope.$on("$destroy",function(){$timeout.cancel(timer)}),$stateParams.stationID?(scope.loadSongs(),StationService.getStationDetails($stateParams.stationID).then(function(station){scope.station=station;var title=scope.station.title;document.title="SomaFM Player: "+title,WebAudioPlayerService.play(scope.station)})):$state.go("")}}}]),angular.module("somafmPlayerApp").directive("sfNowPlayingHeader",["$q","$stateParams","StationService","FavStationsService",function($q,$stateParams,StationService,FavStationsService){return{restrict:"E",replace:!0,scope:{},templateUrl:"now-playing/header.tpl.html",link:function(scope,element,attr){scope.toggleFavStation=function(){FavStationsService.toggle(scope.station)},$q.all([StationService.getStationDetails($stateParams.stationID),FavStationsService.getStations()]).then(function(results){var station=results[0],favStations=results[1];station.favorite=_.contains(favStations,station._id),scope.station=station},function(error){console.log(error)})}}}]),angular.module("somafmPlayerApp").factory("PlayerService",["$q","$rootScope","StationService","StorageService",function($q,$rootScope,StationService,StorageService){var self=this;self.audioNode=null,self.volumeKey="volume",self.lastVolume=null,self.currentTime=0;var loadStreams=function(station){angular.forEach(station.streamUrls.reverse(),function(url){var source=document.createElement("source");source.type=self.audioNode.canPlayType("audio/mpeg;")?"audio/mpeg":source.type="audio/ogg",source.src=url,self.audioNode.appendChild(source)}),self.audioNode.load()},playStream=function(station){self.audioNode.play(),station.playing=!0},play=function(station){return $q(function(resolve,reject){$rootScope.playingStation&&($rootScope.playingStation.playing=!1),null!=station.streamUrls?(loadStreams(station),playStream(station),$rootScope.playingStation=station,resolve($rootScope.playingStation)):StationService.getStationPls(station._id).then(function(data){station.streamUrls=data,loadStreams(station),playStream(station),$rootScope.playingStation=station,resolve($rootScope.playingStation)},reject)})},isPlaying=function(station){return $rootScope.playingStation&&$rootScope.playingStation===station?station.playing:null},stop=function(){return $q(function(resolve){$rootScope.playingStation.playing=!1,console.log("Trying to stop"),null==self.audioNode&&(console.log("audio node is null?"),console.log(self)),self.audioNode.pause(),self.currentTime=0,angular.element(self.audioNode).html(""),resolve()})},getVolume=function(){return self.audioNode?self.audioNode.volume:null},initVolume=function(){return setVolume(StorageService.get(self.volumeKey)||.5)},setVolume=function(value){return getMuted()&&setMuted(!1),self.audioNode.volume=value,StorageService.add(self.volumeKey,value),value},toggleMute=function(){getMuted()&&(self.lastVolume=self.audioNode.volume),self.audioNode.muted=!self.audioNode.muted,setVolume(self.audioNode.muted?0:self.lastVolume)},setMuted=function(value){getMuted()&&(self.lastVolume=self.audioNode.volume),self.audioNode.muted=value,setVolume(value?0:self.lastVolume)},getMuted=function(){return self.audioNode?self.audioNode.muted:null},registerNode=function(audioNode){self.audioNode=audioNode};return{play:play,isPlaying:isPlaying,stop:stop,initVolume:initVolume,setVolume:setVolume,getVolume:getVolume,setMuted:setMuted,toggleMute:toggleMute,getMuted:getMuted,registerNode:registerNode}}]),angular.module("somafmPlayerApp").factory("WebAudioPlayerService",["$q","$rootScope","StationService","StorageService","Audio","AudioContext",function($q,$rootScope,StationService,StorageService,Audio,AudioContext){var self=this;self.audioHolder=null,self.audio=null,self.context=null,self.howl=null,self.volumeKey="volume",self.lastVolume=null,self.currentTime=0;var loadStreams=function(station){for(;self.audio.hasChildNodes();)self.audio.removeChild(self.audio.firstChild);angular.forEach(station.streamUrls.reverse(),function(url){var source=document.createElement("source");source.type=self.audio.canPlayType("audio/mpeg;")?"audio/mpeg":source.type="audio/ogg",source.src=url,self.audio.appendChild(source)}),self.audio.load()},playStream=function(station){var promise=self.audio.play();station.playing=!0,void 0!==promise&&promise["catch"](function(error){stop(),station.playing=!1})},play=function(station){return $q(function(resolve,reject){return null!=station&&null!=$rootScope.playingStation&&station==$rootScope.playingStation&&$rootScope.playingStation.playing?void resolve($rootScope.playingStation):(station!=$rootScope.playingStation&&$rootScope.playingStation&&(stop(),$rootScope.playingStation.playing=!1),void(null!=station.streamUrls?(loadStreams(station),playStream(station),$rootScope.playingStation=station,resolve($rootScope.playingStation)):StationService.getStationPls(station._id).then(function(data){station.streamUrls=data,loadStreams(station),playStream(station),$rootScope.playingStation=station,resolve($rootScope.playingStation)},reject)))})},isPlaying=function(station){return $rootScope.playingStation&&$rootScope.playingStation===station?station.playing:null},stop=function(){return $q(function(resolve){$rootScope.playingStation.playing=!1,self.audio.pause(),self.currentTime=0,self.audioHolder.html(""),resolve()})},getVolume=function(){return self.audio?self.audio.volume:null},initVolume=function(){return setVolume(StorageService.get(self.volumeKey)||.5)},setVolume=function(value){return getMuted()&&setMuted(!1),self.audio.volume=value,StorageService.add(self.volumeKey,value),value},toggleMute=function(){getMuted()&&(self.lastVolume=self.audio.volume),self.audio.muted=!self.audio.muted,setVolume(self.audio.muted?0:self.lastVolume)},setMuted=function(value){getMuted()&&(self.lastVolume=self.audio.volume),self.audio.muted=value,setVolume(value?0:self.lastVolume)},getMuted=function(){return self.audio?self.audio.muted:null},init=function(audioNode){self.audioHolder=angular.element(audioNode),self.audio=new Audio,self.audio.controls=!1,self.audio.autoplay=!0,self.audioHolder[0].appendChild(self.audio);var AudioContext=window.AudioContext||window.webkitAudioContext||!1;AudioContext?self.context=new AudioContext:alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox"),initVolume()};return{play:play,isPlaying:isPlaying,stop:stop,initVolume:initVolume,setVolume:setVolume,getVolume:getVolume,setMuted:setMuted,toggleMute:toggleMute,getMuted:getMuted,init:init}}]);